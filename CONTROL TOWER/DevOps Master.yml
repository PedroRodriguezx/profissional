---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Copyright CloudDog 2020. Configure DevOps infrastructure to be used in DevOps Client accounts.'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: CodeBuild Params
        Parameters:
          - DockerHubSecretArn 
          - DockerHubSecretName
      - Label:
          default: Accounts
        Parameters:
          - DevAccount
          - StgAccount
          - PrdAccount

    ParameterLabels:
      DockerHubSecretArn:
        default: arn:aws:secretsmanager:us-east-1:679493512310:secret:dockerhub-FySLTm
      DockerHubSecretName:
        default: dockerhub
      DevAccount:
        default: dockerhub
      StgAccount:
        default: Staging Account
      PrdAccount:
        default: Production Account
      
Parameters:
  # StackName: 
  #   Type: String
  #   Default: opsfactor-devops-masters

  DevAccount:
    Default: '983797644941'
    Description: Development Account Number
    AllowedPattern: (^$|[0-9]{12})
    ConstraintDescription: "must be a valid account number or empty"
    Type: String
  DockerHubSecretArn:
    Default: 'arn:aws:secretsmanager:us-east-1:679493512310:secret:dockerhub-FySLT'
    Type: String
    Description: Development Account Number
  DockerHubSecretName:
    Default: 'dockerhub' 
    Description: Development Account Number
    Type: String 
  # RepositoryName:
  #   Default: '625536792950'
  #   Description: Development Account Number
  #   AllowedPattern: (^$|[0-9]{12})
  #   ConstraintDescription: "must be a valid account number or empty"
  #   Type: String
  

  # SourceConnectionArn:
  #   Default: arn:aws:codestar-connections:us-east-1:679493512310:connection/c1b66f15-aea3-4f80-a22d-d1a793d6164b
  #   Type: String
  #   Description: The ARN of the connection to the external source code repository  
  StgAccount:
    Default: '466995862261'
    Description: Development Account Number
    AllowedPattern: (^$|[0-9]{12})
    ConstraintDescription: "must be a valid account number or empty"
    Type: String

  PrdAccount:
    Default: '327732600537'
    Description: Development Account Number
    AllowedPattern: (^$|[0-9]{12})
    ConstraintDescription: "must be a valid account number or empty"
    Type: String

  DockerHubSecretArn:
    Description: DockerHub Secret Arn, is a SSM Secret that will be granted access to CodeBuild
    Type: String

  DockerHubSecretName:
    Description: DockerHub Secret Name, is a SSM Secret that will be used during builds in CodeBuild
    Type: String

  StackName:
    Type: String

Conditions:
  DevAccountCondition: !Not [ !Equals [ 983797644941, '' ] ]  
  StgAccountCondition: !Not [ !Equals [ !Ref StgAccount, '' ] ]  
  PrdAccountCondition: !Not [ !Equals [ !Ref PrdAccount, '' ] ]  
  DockerHubSecretArnCondition: !Not [ !Equals [ arn:aws:secretsmanager:us-east-1:679493512310:secret:dockerhub-FySLT, '' ] ]  
  DockerHubSecretNameCondition: !Not [ !Equals [ dockerhub, '' ] ]  

Resources:
  MergeRequestTopic:
    Type: AWS::SNS::Topic

  PipelineNotificationTopic:
    Type: AWS::SNS::Topic

  ApprovalRequestTopic:
    Type: AWS::SNS::Topic

  CloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - cloudformation.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/service-role/"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess

  ArtifactsBucket:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::S3::Bucket
    Properties: 
      LifecycleConfiguration:
        Rules:
          - Id: !Sub ${StackName}-auto-cleanup
            ExpirationInDays: 30
            Status: Enabled        
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  CacheBucket:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::S3::Bucket
    Properties: 
      LifecycleConfiguration:
        Rules:
          - Id: !Sub ${StackName}-auto-cleanup
            ExpirationInDays: 30
            Status: Enabled    
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  ArtifactsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ArtifactsBucket
      PolicyDocument:
        Statement:
          - Sid: DenyUnEncryptedObjectUploads
            Effect: Deny
            Principal: "*"
            Action: s3:PutObject
            Resource: !Sub "arn:aws:s3:::${ArtifactsBucket}/*"
            Condition:
              StringNotEquals:
                s3:x-amz-server-side-encryption: aws:kms
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource: !Sub "arn:aws:s3:::${ArtifactsBucket}/*"
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Sid: AllowCrossAccountAccess
            Effect: "Allow"
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
            Resource: !Sub "arn:aws:s3:::${ArtifactsBucket}/*"
            Principal:
              AWS: 
                - !If [ DevAccountCondition, !Sub "arn:aws:iam::983797644941:root", !Ref AWS::NoValue ]
                - !If [ StgAccountCondition, !Sub "arn:aws:iam::${StgAccount}:root", !Ref AWS::NoValue ]
                - !If [ PrdAccountCondition, !Sub "arn:aws:iam::${PrdAccount}:root", !Ref AWS::NoValue ]

  ArtifactsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: DevOps CodePipeline symmetric key for cross account deployment
      KeyPolicy:
        Version: '2012-10-17'
        Id: key-default-1
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal: 
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: 
              - kms:*
            Resource: '*'
          - Sid: Allow use of the key
            Effect: Allow
            Principal:
              AWS:  
                - !GetAtt CodePipelineRole.Arn
                - !If [ DevAccountCondition, !Sub "arn:aws:iam::983797644941:root", !Ref AWS::NoValue ]
                - !If [ StgAccountCondition, !Sub "arn:aws:iam::${StgAccount}:root", !Ref AWS::NoValue ]
                - !If [ PrdAccountCondition, !Sub "arn:aws:iam::${PrdAccount}:root", !Ref AWS::NoValue ]
            Action: 
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
          - Sid: Allow attachment of persistent resources
            Effect: Allow
            Principal:
              AWS:  
                - !GetAtt CodePipelineRole.Arn
                - !If [ DevAccountCondition, !Sub "arn:aws:iam::983797644941:root", !Ref AWS::NoValue ]
                - !If [ StgAccountCondition, !Sub "arn:aws:iam::${StgAccount}:root", !Ref AWS::NoValue ]
                - !If [ PrdAccountCondition, !Sub "arn:aws:iam::${PrdAccount}:root", !Ref AWS::NoValue ]
            Action: 
             - kms:CreateGrant
             - kms:ListGrants
             - kms:RevokeGrant
            Resource: '*'   
            Condition:
              Bool:
                "kms:GrantIsForAWSResource": true

  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - codebuild.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/service-role/"
      Policies:
      - PolicyName: CodeBuildTrustPolicy
        PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/625536792950-build
                  - Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/625536792950-build:*
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource:
                  - Fn::Sub: arn:aws:s3:::${ArtifactsBucket}/*
              - Effect: Allow
                Action:
                  - codebuild:CreateReportGroup
                  - codebuild:CreateReport
                  - codebuild:UpdateReport
                  - codebuild:BatchPutTestCases
                Resource: "*"
      - PolicyName: codebuild-service
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: "*"
            Resource: "*"          
      - PolicyName: codebuild-ecr
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - ecr:BatchCheckLayerAvailability
            - ecr:CompleteLayerUpload
            - ecr:GetAuthorizationToken
            - ecr:InitiateLayerUpload
            - ecr:PutImage
            - ecr:UploadLayerPart
            Resource: "*"  

  DockerHubSecretPolicy:
    Type: AWS::IAM::Policy
    Condition: DockerHubSecretArnCondition
    Properties:
      PolicyName: dockerhub-secret
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
            - secretsmanager:GetSecretValue
            Resource: 
            - !If [ DockerHubSecretArnCondition, arn:aws:secretsmanager:us-east-1:679493512310:secret:dockerhub-FySLT, !Ref 'AWS::NoValue' ]
      Roles: 
        - !Ref CodeBuildRole

  CodeDeployRole: 
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: "/service-role/"
      ManagedPolicyArns: 
        - arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS
      Policies:
        - PolicyName: codepipeline-service
          PolicyDocument:
            Statement:
              - Action:
                - s3:GetObject
                - s3:GetObjectVersion
                - s3:GetBucketVersioning
                Resource: "*"
                Effect: Allow

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - codepipeline.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/service-role/"
      Policies:
      - PolicyName: CodePipelineTrustPolicy
        PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource:
                  arn:aws:codestar-connections:us-east-1:679493512310:connection/c1b66f15-aea3-4f80-a22d-d1a793d6164b
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource:
                  - "*"
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:CreateStack
                  - cloudformation:DeleteStack
                  - cloudformation:UpdateStack
                  - cloudformation:DescribeChangeSet
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:SetStackPolicy
                  - cloudformation:ValidateTemplate
                Resource:
                  - "*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - "*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource:
                  - Fn::GetAtt: ArtifactsBucket.Arn
                  - Fn::Sub: arn:aws:s3:::${ArtifactsBucket}/*
      - PolicyName: codepipeline-service
        PolicyDocument:
          Statement:
          - Action:
            - codecommit:GetBranch
            - codecommit:GetCommit
            - codecommit:UploadArchive
            - codecommit:GetUploadArchiveStatus
            - codecommit:CancelUploadArchive
            - codebuild:*
            Resource: "*"
            Effect: Allow
          - Action:
            - s3:*         
            Resource: "*"
            Effect: Allow
          - Action:
            - s3:PutObject
            Resource:
            - arn:aws:s3:::codepipeline*
            - arn:aws:s3:::elasticbeanstalk*
            Effect: Allow
          - Action:
            - codedeploy:CreateDeployment
            - codedeploy:GetApplicationRevision
            - codedeploy:GetDeployment
            - codedeploy:GetDeploymentConfig
            - codedeploy:RegisterApplicationRevision
            Resource: "*"
            Effect: Allow
          - Action:
            - elasticbeanstalk:*
            - ec2:*
            - elasticloadbalancing:*
            - autoscaling:*
            - cloudwatch:*
            - s3:*
            - sns:*
            - cloudformation:*
            - rds:*
            - sqs:*
            - ecs:*
            - ecr:*
            - iam:PassRole
            Resource: "*"
            Effect: Allow
          - Action:
            - lambda:InvokeFunction
            - lambda:ListFunctions
            Resource: "*"
            Effect: Allow
            
          Version: '2012-10-17'

  CloudWatchRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - events.amazonaws.com
            Action: sts:AssumeRole
      Path: /service-role/
      Policies:
        - PolicyName: cwe-pipeline-execution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: codepipeline:StartPipelineExecution
                Resource: "*"

  DenyChangesToMasterPolicy:
    Type: 'AWS::IAM::ManagedPolicy'
    Properties:
      Description: Policy that denies push to master branches
      Path: /
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Deny
            Action:
              - codecommit:GitPush
              - codecommit:DeleteBranch
              - codecommit:PutFile
              - codecommit:MergeBranchesByFastForward
              - codecommit:MergeBranchesBySquash
              - codecommit:MergeBranchesByThreeWay
              - codecommit:MergePullRequestByFastForward
              - codecommit:MergePullRequestBySquash
              - codecommit:MergePullRequestByThreeWay
            Resource: 
              - '*'
            Condition:
              StringEqualsIfExists:
                codecommit:References:
                  - refs/heads/master
                  - refs/heads/prod
              'Null':
                codecommit:References: false

  AssumeRoleDevPolicy:
    Type: AWS::IAM::Policy
    Condition: DevAccountCondition
    Properties:
      PolicyName: dev_assume_role
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Resource: 
              - !Sub "arn:aws:iam::${DevAccount}:role/*"
      Roles: 
        - !Ref CodePipelineRole
        - !Ref CodeDeployRole

  AssumeRoleStgPolicy:
    Type: AWS::IAM::Policy
    Condition: StgAccountCondition
    Properties:
      PolicyName: stg_assume_role
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Resource: 
              - !Sub "arn:aws:iam::${StgAccount}:role/*"
      Roles: 
        - !Ref CodePipelineRole
        - !Ref CodeDeployRole

  AssumeRolePrdPolicy:
    Type: AWS::IAM::Policy
    Condition: PrdAccountCondition
    Properties:
      PolicyName: prd_assume_role
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Resource: 
              - !Sub "arn:aws:iam::${PrdAccount}:role/*"
      Roles: 
        - !Ref CodePipelineRole
        - !Ref CodeDeployRole

Outputs:

  StackName:
    Value: !Ref StackName
    Description: Stack Name

  DevAccountId:
    Condition: DevAccountCondition
    Value: 983797644941
    Description: Development Account Id
    Export:
      Name: !Sub ${StackName}-DevAccountId

  # StackName:
  #   Description: "Name of the CloudFormation stack"
  #   Value: !Ref ${StackName}    

  StgAccountId:
    Condition: StgAccountCondition
    Value: !Ref StgAccount
    Description: Staging Account Id
    Export:
      Name: !Sub ${StackName}-StgAccountId

  PrdAccountId:
    Condition: PrdAccountCondition
    Value: !Ref PrdAccount
    Description: Production Account Id
    Export:
      Name: !Sub ${StackName}-PrdAccountId

  ArtifactsBucketName:
    Value: !Ref ArtifactsBucket
    Description: Bucket for CodePipeline artifacts
    Export:
      Name: !Sub ${StackName}-ArtifactsBucketName

  # SourceConnectionArn:
  #   Value: arn:aws:codestar-connections:us-east-1:679493512310:connection/c1b66f15-aea3-4f80-a22d-d1a793d6164bn
  #   Description: SourceConnectionArn
  #   Export:
  #     Name: !Sub ${StackName}-SourceConnectionArn    
  
  ArtifactsKeyArn:
    Value: !GetAtt ArtifactsKey.Arn
    Description: ArtifactsKey Arn
    Export:
      Name: !Sub ${StackName}-ArtifactsKeyArn

  CacheBucketName:
    Value: !Ref CacheBucket
    Description: Bucket for Cache CodeBuild artifacts
    Export:
      Name: !Sub ${StackName}-CacheBucketName
      

  CodePipelineRoleArn:
    Value: !GetAtt CodePipelineRole.Arn
    Description: CodePipeline Service Role Arn
    Export:
      Name: !Sub ${StackName}-CodePipelineRoleArn

  CodeDeployRoleArn:
    Value: !GetAtt CodeDeployRole.Arn
    Description: CodeDeploy Service Role Arn
    Export:
      Name: !Sub ${StackName}-CodeDeployRoleArn      

  CodeBuildRoleArn:
    Value: !GetAtt CodeBuildRole.Arn
    Description: CodeBuild Service Role Arn
    Export:
      Name: !Sub ${StackName}-CodeBuildRoleArn  

  CloudWatchRoleArn:
    Value: !GetAtt CloudWatchRole.Arn
    Description: CloudWatch Service Role Arn
    Export:
      Name: !Sub ${StackName}-CloudWatchRoleArn  

  DenyChangesToMasterPolicyArn:
    Value: !Ref DenyChangesToMasterPolicy
    Description: Policy that denies changes to master
    Export:
      Name: !Sub ${StackName}-DenyChangesToMasterPolicyArn       

  CloudFormationRoleArn:
    Value: !GetAtt CloudFormationRole.Arn
    Description: CloudFormation Role used by DevOps Account
    Export:
      Name: 
        Fn::Sub: ${StackName}-CloudFormationRoleArn        

  MergeRequestTopicArn:
    Value: !Ref MergeRequestTopic
    Description: Merge Request Topic for Repositories
    Export:
      Name: 
        Fn::Sub: ${StackName}-MergeRequestTopicArn  

  # PushNotificationTopicArn:
  #   Value: !Ref PushNotificationTopic
  #   Description: Push Notification Topic for Repositories
  #   Export:
  #     Name: 
  #       Fn::Sub: ${StackName}-PushNotificationTopicArn  

  # ApprovalRequestTopicArn:
  #   Value: !Ref ApprovalRequestTopic
  #   Description: Approval Request Topic for Repositories
  #   Export:
  #     Name: 
  #       Fn::Sub: ${StackName}-ApprovalRequestTopicArn  

  DockerHubSecretArn:
    Condition: DockerHubSecretArnCondition
    Value: arn:aws:secretsmanager:us-east-1:679493512310:secret:dockerhub-FySLT
    Description: DockerHub Secret Arn
    Export:
      Name: 
        Fn::Sub: ${StackName}-arn:aws:secretsmanager:us-east-1:679493512310:secret:dockerhub-FySLT 

  DockerHubSecretName:
    Condition: DockerHubSecretNameCondition
    Value: dockerhub
    Description: DockerHub Secret Name
    Export:
      Name: 
        Fn::Sub: ${StackName}-DockerHubSecretName   
